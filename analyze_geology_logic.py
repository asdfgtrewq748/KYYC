"""
åˆ†æåœ°è´¨ç‰¹å¾åœ¨æ¨¡å‹ä¸­çš„å½±å“é€»è¾‘
"""
import numpy as np
import torch
from optimized_model import SimpleButEffectiveModel

print("=" * 70)
print("ğŸ”¬ åœ°è´¨å› ç´ å½±å“é€»è¾‘åˆ†æ")
print("=" * 70)

# åŠ è½½æ•°æ®
data = np.load('processed_data/sequence_dataset.npz')
X = data['X']
y_final = data['y_final']

print(f"\nğŸ“Š æ•°æ®é›†ä¿¡æ¯:")
print(f"æ ·æœ¬æ•°: {X.shape[0]:,}")
print(f"åºåˆ—é•¿åº¦: {X.shape[1]}")
print(f"ç‰¹å¾ç»´åº¦: {X.shape[2]}")

print(f"\nğŸ“‹ ç‰¹å¾åˆ†å¸ƒ (å…±{X.shape[2]}ç»´):")
print(f"  [0:6]   å‹åŠ›ç‰¹å¾ (6ç»´)")
print(f"  [6:15]  åœ°è´¨ç‰¹å¾ (9ç»´)")
print(f"  [15:17] æ—¶é—´ç‰¹å¾ (2ç»´)")

# åˆ†æåœ°è´¨ç‰¹å¾
print("\n" + "=" * 70)
print("ğŸª¨ åœ°è´¨ç‰¹å¾ç»Ÿè®¡")
print("=" * 70)

geo_features = X[:, -1, 6:15]  # å–æœ€åæ—¶é—´æ­¥çš„åœ°è´¨ç‰¹å¾
geo_names = [
    'total_thickness_m',      # æ€»åšåº¦
    'coal_thickness_m',       # ç…¤å±‚åšåº¦
    'coal_seam_count',        # ç…¤å±‚æ•°é‡
    'depth_to_top_coal_m',    # é¡¶æ¿æ·±åº¦
    'avg_elastic_modulus_GPa', # å¼¹æ€§æ¨¡é‡
    'avg_density_kN_m3',      # å¯†åº¦
    'max_tensile_MPa',        # æŠ—æ‹‰å¼ºåº¦
    'prop_sandstone',         # ç ‚å²©å æ¯”
    'prop_mudstone'           # æ³¥å²©å æ¯”
]

print(f"\næ¯ä¸ªåœ°è´¨ç‰¹å¾çš„å˜åŒ–èŒƒå›´:")
for i, name in enumerate(geo_names):
    values = geo_features[:, i]
    unique_count = len(np.unique(values))
    print(f"  {i+1}. {name:25s}: "
          f"èŒƒå›´[{values.min():8.2f}, {values.max():8.2f}], "
          f"å”¯ä¸€å€¼æ•°é‡: {unique_count}")

# åˆ†æåœ°è´¨ç‰¹å¾çš„ä¸å˜æ€§
print(f"\nğŸ” åœ°è´¨ç‰¹å¾çš„æ—¶åºç‰¹æ€§:")
for sample_idx in [0, 1000, 5000]:
    if sample_idx < X.shape[0]:
        geo_seq = X[sample_idx, :, 6:15]  # æ•´ä¸ªåºåˆ—çš„åœ°è´¨ç‰¹å¾
        is_constant = np.all(geo_seq == geo_seq[0], axis=0)
        constant_count = np.sum(is_constant)
        print(f"  æ ·æœ¬{sample_idx}: {constant_count}/9 ä¸ªåœ°è´¨ç‰¹å¾åœ¨åºåˆ—ä¸­ä¿æŒä¸å˜")

# åˆ†ææ¨¡å‹ä¸­çš„ä½¿ç”¨
print("\n" + "=" * 70)
print("ğŸ§  æ¨¡å‹ä¸­çš„åœ°è´¨ç‰¹å¾å¤„ç†é€»è¾‘")
print("=" * 70)

model = SimpleButEffectiveModel()
print(f"\n1ï¸âƒ£ ç‰¹å¾æå–é˜¶æ®µ:")
print(f"   ä»£ç : geology_features = x[:, -1, 6:15]")
print(f"   é€»è¾‘: ä»5ä¸ªæ—¶é—´æ­¥ä¸­åªå–ã€æœ€åä¸€ä¸ªæ—¶é—´æ­¥ã€‘çš„åœ°è´¨ç‰¹å¾")
print(f"   åŸå› : åœ°è´¨ç‰¹å¾åœ¨æ•´ä¸ªåºåˆ—ä¸­ç›¸åŒï¼Œåªå–ä¸€æ¬¡é¿å…å†—ä½™")

print(f"\n2ï¸âƒ£ åœ°è´¨ç‰¹å¾ç¼–ç :")
print(f"   æ¨¡å—: geo_encoder (MLP)")
print(f"   ç»“æ„:")
print(f"     - Linear(9 â†’ 128)")
print(f"     - BatchNorm1d(128)")
print(f"     - ReLU()")
print(f"     - Dropout(0.3)")
print(f"   ä½œç”¨: å°†9ç»´åŸå§‹åœ°è´¨ç‰¹å¾æ˜ å°„åˆ°128ç»´åµŒå…¥ç©ºé—´")

print(f"\n3ï¸âƒ£ ç‰¹å¾èåˆ:")
print(f"   å‹åŠ›ç‰¹å¾(LSTMè¾“å‡º): (batch, 256)")
print(f"   åœ°è´¨ç‰¹å¾(ç¼–ç å):   (batch, 128)")
print(f"   æ—¶é—´ç‰¹å¾(ç¼–ç å):   (batch, 64)")
print(f"   èåˆæ–¹å¼: torch.cat([å‹åŠ›, åœ°è´¨, æ—¶é—´], dim=-1)")
print(f"   èåˆç»“æœ: (batch, 448)")
print(f"   é€»è¾‘: ç®€å•æ‹¼æ¥ï¼Œæœªå»ºæ¨¡äº¤äº’å…³ç³»")

print(f"\n4ï¸âƒ£ é¢„æµ‹é˜¶æ®µ:")
print(f"   è¾“å…¥: èåˆç‰¹å¾ (batch, 448)")
print(f"   é€šè¿‡: 4å±‚MLP (448â†’256â†’128â†’64â†’1)")
print(f"   è¾“å‡º: æœ«é˜»åŠ›é¢„æµ‹å€¼ (batch, 1)")

# åœ°è´¨ç‰¹å¾çš„å®é™…å½±å“
print("\n" + "=" * 70)
print("ğŸ“ˆ åœ°è´¨ç‰¹å¾çš„å½±å“æœºåˆ¶")
print("=" * 70)

print(f"\nâœ… å½“å‰æ¨¡å‹çš„åœ°è´¨å½±å“é€»è¾‘:")
print(f"   1. ç©ºé—´ç»´åº¦:")
print(f"      - æ¯ä¸ªæ”¯æ¶é€šè¿‡KDTreeåŒ¹é…æœ€è¿‘çš„é’»å­”")
print(f"      - ç›´æ¥å¤åˆ¶è¯¥é’»å­”çš„9ä¸ªåœ°è´¨ç‰¹å¾")
print(f"      - 19ä¸ªé’»å­” â†’ è¦†ç›–æ‰€æœ‰æ”¯æ¶")
print(f"")
print(f"   2. æ—¶é—´ç»´åº¦:")
print(f"      - åœ°è´¨ç‰¹å¾åœ¨æ•´ä¸ªåºåˆ—ä¸­ã€ä¿æŒä¸å˜ã€‘")
print(f"      - åŒä¸€æ”¯æ¶çš„è¿ç»­5ä¸ªæ—¶é—´æ­¥ä½¿ç”¨ç›¸åŒçš„åœ°è´¨ç‰¹å¾")
print(f"      - åˆç†ï¼šåœ°è´¨æ¡ä»¶çŸ­æœŸå†…ä¸å˜")
print(f"")
print(f"   3. æ¨¡å‹ç»´åº¦:")
print(f"      - åœ°è´¨ç‰¹å¾é€šè¿‡MLPç¼–ç ä¸º128ç»´å‘é‡")
print(f"      - ä¸å‹åŠ›ã€æ—¶é—´ç‰¹å¾æ‹¼æ¥åè¾“å…¥é¢„æµ‹å±‚")
print(f"      - ç‰¹å¾é—´ã€æ— æ˜¾å¼äº¤äº’å»ºæ¨¡ã€‘")

print(f"\nâŒ å½“å‰æ–¹æ³•çš„å±€é™æ€§:")
print(f"   1. ç®€å•æ‹¼æ¥èåˆ:")
print(f"      é—®é¢˜: åœ°è´¨ç‰¹å¾ä¸å‹åŠ›ç‰¹å¾æ˜¯ç‹¬ç«‹ç¼–ç ï¼ŒåæœŸæ‰æ‹¼æ¥")
print(f"      å½±å“: æ— æ³•å­¦ä¹ 'åœ¨æŸç§åœ°è´¨æ¡ä»¶ä¸‹ï¼Œå‹åŠ›å¦‚ä½•æ¼”å˜'")
print(f"")
print(f"   2. æœ€è¿‘é‚»æ’å€¼:")
print(f"      é—®é¢˜: åªç”¨æœ€è¿‘çš„1ä¸ªé’»å­”ï¼Œæœªè€ƒè™‘å‘¨å›´é’»å­”")
print(f"      å½±å“: åœ°è´¨ç‰¹å¾çš„ç©ºé—´å¹³æ»‘æ€§ä¸¢å¤±")
print(f"")
print(f"   3. çº¿æ€§æ˜ å°„:")
print(f"      é—®é¢˜: å•å±‚Linearæ— æ³•æ•è·ç‰¹å¾é—´å¤æ‚å…³ç³»")
print(f"      å½±å“: å¦‚'é«˜å¯†åº¦+é«˜æ¨¡é‡â†’åšç¡¬é¡¶æ¿'éœ€è¦éçº¿æ€§å»ºæ¨¡")

print(f"\nâœ¨ å¢å¼ºæ¨¡å‹çš„æ”¹è¿›:")
print(f"   1. å¤šå¤´æ³¨æ„åŠ›èåˆ:")
print(f"      æ”¹è¿›: å­¦ä¹ 9ä¸ªåœ°è´¨ç‰¹å¾ä¹‹é—´çš„å…³ç³»")
print(f"      ç¤ºä¾‹: å¯†åº¦â†”å¼¹æ€§æ¨¡é‡, ç ‚å²©å æ¯”â†”æŠ—æ‹‰å¼ºåº¦")
print(f"")
print(f"   2. åŒçº¿æ€§äº¤äº’:")
print(f"      æ”¹è¿›: å»ºæ¨¡ å‹åŠ›ç‰¹å¾ Ã— åœ°è´¨ç‰¹å¾ çš„äº¤äº’")
print(f"      ç¤ºä¾‹: é«˜å‹åŠ› Ã— ç¡¬é¡¶æ¿ â†’ åº”åŠ›é›†ä¸­")
print(f"")
print(f"   3. é—¨æ§æœºåˆ¶:")
print(f"      æ”¹è¿›: åŠ¨æ€è°ƒèŠ‚åœ°è´¨å½±å“çš„å¼ºåº¦")
print(f"      ç¤ºä¾‹: åœ¨å‹åŠ›å‰§å˜æ—¶ï¼Œåœ°è´¨å½±å“æƒé‡å¢åŠ ")

print("\n" + "=" * 70)
print("ğŸ¯ æ€»ç»“")
print("=" * 70)
print(f"""
å½“å‰åœ°è´¨å› ç´ å½±å“é€»è¾‘ï¼š

ã€æ•°æ®å±‚ã€‘
  é’»å­”(19ä¸ª) --KDTree--> æ”¯æ¶ --å¤åˆ¶--> åœ°è´¨ç‰¹å¾(9ç»´)
  ç‰¹ç‚¹: æœ€è¿‘é‚»åŒ¹é…ï¼Œç©ºé—´ç¦»æ•£

ã€æ—¶åºå±‚ã€‘
  æ—¶é—´æ­¥1-5çš„åœ°è´¨ç‰¹å¾ã€å®Œå…¨ç›¸åŒã€‘
  ç‰¹ç‚¹: é™æ€ç‰¹å¾ï¼Œç¬¦åˆåœ°è´¨ä¸å˜æ€§

ã€æ¨¡å‹å±‚ã€‘
  åœ°è´¨(9ç»´) --MLP--> åµŒå…¥(128ç»´) --Concat--> èåˆ(448ç»´) --MLP--> é¢„æµ‹(1ç»´)
  ç‰¹ç‚¹: ç®€å•æ‹¼æ¥ï¼Œæ— äº¤äº’å»ºæ¨¡

ã€ç‰©ç†æ„ä¹‰ã€‘
  åœ°è´¨ç‰¹å¾æä¾›"èƒŒæ™¯æ¡ä»¶"ï¼š
  - ç¡¬é¡¶æ¿(é«˜æ¨¡é‡) â†’ åŸºçº¿å‹åŠ›é«˜
  - è½¯é¡¶æ¿(é«˜æ³¥å²©) â†’ å‹åŠ›æ³¢åŠ¨å¤§
  
ã€æ”¹è¿›æ–¹å‘ã€‘
  â†’ æ³¨æ„åŠ›æœºåˆ¶ï¼šå­¦ä¹ åœ°è´¨ç‰¹å¾é—´å…³ç³»
  â†’ åŒçº¿æ€§äº¤äº’ï¼šå»ºæ¨¡åœ°è´¨Ã—å‹åŠ›çš„äºŒé˜¶æ•ˆåº”
  â†’ ç©ºé—´æ’å€¼ï¼šåˆ©ç”¨å¤šé’»å­”ä¿¡æ¯
""")

print("=" * 70)
