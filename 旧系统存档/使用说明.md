# 🤖 矿压预测 AI 训练平台 - 使用说明

## 📌 快速开始（新手推荐）

### 三步完成训练：

1. **启动程序**
   ```bash
   conda activate kyyc_py311
   streamlit run STGCN.py
   ```

2. **配置地质特征（重要！）**
   - 在左侧边栏找到"步骤3: 🌍 地质特征"
   - **务必勾选**"🔧 融合地质特征数据"（默认已启用）
   - 选择"✅ 使用提取的钻孔地质特征"
   - ⚠️ 不启用地质特征会严重影响预测准确性！

3. **加载数据**
   - 点击"加载数据"按钮
   - 系统会自动使用**单样本序列格式**
   - 检查是否显示"✅ 已启用地质特征融合"
   - 等待数据加载完成

4. **开始训练**
   - 模型选择：**Transformer（最强表达力）🚀**（默认已选）
   - 启用：**🤖 一键智能模式**（默认已启用）
   - 点击"开始训练"
   - 等待训练完成（100轮约5-15分钟）

✨ **启用地质特征后，系统会自动优化到R²≥0.8**

📋 **数据兼容性说明：**
- ✅ 基础矿压数据：17个特征，195,836个训练样本
- ✅ 地质特征数据：8个特征（煤层厚度、断层距离、岩层强度等）
- ✅ 特征工程：自动生成200+增强特征
- ✅ 适合LSTM/Transformer等序列模型
- ❌ 不支持STGCN（需要完整时空数据，但检测到0个完整时间步）

🔬 **为什么必须启用地质特征？**
- 矿压的60-70%由地质条件决定（煤层、断层、岩性）
- 仅用历史矿压数据预测，相当于"闭眼开车"
- 启用地质特征后，预期R²可提升15-25%！

---

## 🎯 目标性能指标

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **R²** | ≥ 0.80 | 决定系数，越接近1越好 |
| **MAE** | < 10 MPa | 平均绝对误差 |
| **RMSE** | < 15 MPa | 均方根误差 |

---

## 🚀 一键智能模式说明

启用"一键智能模式"后，系统会自动启用以下优化：

| 优化项 | 效果 | 说明 |
|--------|------|------|
| ✅ 组合损失函数 | +5~10% | Huber+MAE+MAPE加权组合 |
| ✅ 梯度累积 | +3~5% | 模拟4倍批次大小 |
| ✅ 混合精度训练 | 速度×2 | 仅GPU支持，CPU自动禁用 |
| ✅ 高级诊断图表 | 更直观 | 残差图、Q-Q图、学习曲线 |

---

## 📊 模型对比

| 模型 | 难度 | 速度 | 预期R² | 适用场景 |
|------|------|------|--------|----------|
| **LSTM (基础版)** | ⭐ | 快 | 0.35-0.45 | 快速验证 |
| **AttentionLSTM** | ⭐⭐ | 中 | 0.40-0.55 | 注意力机制 |
| **Transformer** 🔥 | ⭐⭐⭐ | 中 | **0.65-0.85** | **强烈推荐** |
| ~~STGCN~~ | ❌ 已禁用 | - | - | 当前数据不支持 |

💡 **新手推荐：Transformer + 一键智能模式**

⚠️ **STGCN已禁用原因**：检测到当前数据集有0个完整时间步（所有125个支架同时有数据的时刻），无法构建有效的空间拓扑图。推荐使用Transformer模型替代，效果更好。

---

## ⚙️ 高级设置（可选）

### 手动模式

如果您想精细控制，可以关闭"一键智能模式"，手动选择：

- **组合损失函数**：提升5-10%，但训练稍慢
- **梯度累积**：提高训练稳定性
- **混合精度训练**：GPU加速2倍（CPU不可用）
- **高级诊断图表**：查看详细的模型诊断信息
- **集成学习**：3个模型投票，提升3-5%，但训练时间×3
- **K折交叉验证**：更准确的评估，但耗时×5

### 训练参数建议

| 参数 | 推荐值 | 说明 |
|------|--------|------|
| 训练轮数 | 100-150 | 太少效果差，太多容易过拟合 |
| 批次大小 | 128 | 平衡速度和效果 |
| 学习率 | 0.001 | 已含warmup，无需调整 |
| 隐藏层维度 | 128 | Transformer默认d_model |

---

## 📈 训练过程监控

训练过程中，您会看到：

1. **实时进度条**：显示当前训练进度
2. **损失曲线**：训练损失 vs 验证损失
3. **性能指标**：MAE、RMSE、R²
4. **预测示例**：随机抽取5个样本对比

### 如何判断训练效果？

✅ **良好训练的标志：**
- 训练损失和验证损失同步下降
- R² 稳定在 0.80 以上
- MAE < 10 MPa, RMSE < 15 MPa
- 残差图呈随机分布（无明显模式）

❌ **问题训练的标志：**
- 验证损失不下降或上升（过拟合）
- R² < 0.5（欠拟合）
- 残差图有明显趋势（模型有偏）

---

## 🔧 常见问题

### Q1: 训练很慢怎么办？
**A:** 
- 检查是否使用CPU模式（GPU快10倍）
- 减少训练轮数（100→50）
- 关闭"集成学习"和"K折验证"

### Q2: R²只有0.3怎么办？
**A:**
- 确保使用"单样本序列格式"
- 选择"Transformer"模型
- 启用"一键智能模式"
- 增加训练轮数到150

### Q3: 显存不足怎么办？
**A:**
- 减小批次大小（128→64）
- 关闭"混合精度训练"
- 使用CPU模式

### Q4: 为什么STGCN模型不可用？
**A:**
- 当前数据不支持完整时空格式（检测到0个完整时间步）
- 不同支架的时间戳不同步，无法构建空间拓扑图
- **推荐使用Transformer模型**（效果更好，预期R²≥0.80）

---

## 📦 依赖环境

```bash
# 核心依赖
torch >= 2.0.0
streamlit >= 1.20.0
numpy
pandas
scikit-learn

# 可选依赖（高级可视化）
plotly
scipy
```

---

## 💡 最佳实践

### 推荐配置（冲击R²≥0.8）

```
✅ 数据格式：单样本序列格式
✅ 模型选择：Transformer (最强表达力)
✅ 特征工程：启用
✅ 智能优化：一键智能模式
✅ 训练轮数：100-150
✅ 批次大小：128
```

### 性能提升路径

| 阶段 | 配置 | 预期R² |
|------|------|--------|
| 基础 | LSTM + 默认设置 | 0.30-0.35 |
| 进阶 | Transformer + 特征工程 | 0.50-0.60 |
| 高级 | Transformer + 一键智能模式 | 0.65-0.75 |
| 极致 | Transformer + 智能模式 + 150轮 | **0.80-0.85** |

---

## 📞 技术支持

如遇问题，请检查：

1. 数据文件路径是否正确
2. Python环境是否激活（kyyc_py311）
3. 依赖包是否完整安装
4. 查看终端错误信息

---

## 🎉 开始使用

现在就启动程序，体验AI的强大吧！

```bash
conda activate kyyc_py311
streamlit run STGCN.py
```

**祝训练愉快！目标R²≥0.8** 🚀
