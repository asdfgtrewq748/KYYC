# 🚨 紧急修复：禁用特征工程

## 问题诊断

你遇到的NaN问题是因为：**特征工程被误启用了**

证据：
- 错误信息显示"264个特征"
- 正常应该只有25个特征（17矿压+8地质）
- 特征工程会添加200+特征，导致数值爆炸

---

## 🎯 立即解决方案

### 步骤1：重启应用
```powershell
# 停止当前运行（Ctrl+C）
# 重新启动
streamlit run STGCN.py
```

### 步骤2：正确配置界面

在Streamlit界面中：

#### ⚠️ 特征配置区域（最重要！）

看到红色警告框："重要警告：特征工程已知会导致NaN！"

✅ **确保这个勾选框为未勾选状态：**
```
[ ] 启用特征工程（⚠️不推荐，已知导致NaN）
```

✅ **应该看到绿色成功框：**
```
✅ 特征工程已禁用（推荐配置）
- 使用25个基础特征（17矿压 + 8地质）
- 数值稳定，不会出现NaN
- 已足够达到R²≥0.70的目标
```

#### 其他配置

1. **额外保守模式：** 不勾选（基础配置已足够）
2. **模型选择：** Transformer
3. **Smart模式：** 启用
4. **学习率：** 0.001（默认即可）
5. **Batch Size：** 32（默认即可）

### 步骤3：加载数据

点击"开始训练"

**关键检查点：**

在"步骤1.9: 训练前最终检查"中，必须看到：

```
✅ 特征数量正确：25个特征
- 17个矿压特征
- 8个地质特征  
- 特征工程已禁用（正确配置）
- 可以安全开始训练！
```

❌ **如果看到：**
```
❌❌❌ 严重警告：检测到264个特征！
```
**说明特征工程仍被启用！** → 返回步骤2，确保未勾选

### 步骤4：开始训练

如果步骤3检查通过，训练应该顺利进行：

- ✅ 不会出现NaN
- ✅ 损失稳定下降
- ✅ 预期R² > 0.70

---

## 🔍 如何确认特征工程已禁用

### 方法1：界面检查
- 配置区域有绿色"✅ 特征工程已禁用"
- 没有"步骤1.5: 特征工程"的执行记录

### 方法2：特征数量检查
- 数据加载后，查看"步骤1.9: 训练前最终检查"
- 必须显示"25个特征"

### 方法3：训练日志检查
- 训练开始时，模型输入应该是：
  ```
  输入形状: (batch_size, 20, 25)  ← 25个特征
  ```
- 不应该是：
  ```
  输入形状: (batch_size, 20, 264)  ← 264个特征（错误！）
  ```

---

## 📊 预期结果

### 正确配置（25特征）
- ✅ 训练稳定，无NaN
- ✅ 每个epoch约2-3分钟
- ✅ R² 逐渐提升到0.70-0.80
- ✅ 100个epoch后达到最佳效果

### 错误配置（264特征）
- ❌ epoch 1就出现NaN
- ❌ 通常在batch 50-70左右失败
- ❌ 损失变为nan或inf
- ❌ 训练立即终止

---

## 🎓 为什么特征工程会导致NaN？

1. **数值范围爆炸：**
   - 基础特征：[0, 23000] MPa（矿压值）
   - 归一化后：[-1, 1]
   - 特征工程计算统计值时：差分/比率可能产生极大或极小值
   - 例如：两个接近0的归一化值相除 → Inf

2. **梯度不稳定：**
   - 264个特征 → 模型参数量急剧增加
   - 更多参数 → 梯度计算更复杂
   - 容易出现梯度爆炸/消失

3. **过拟合风险：**
   - 15万样本 vs 264个特征
   - 特征过多，模型学习噪声而非规律
   - 预测不稳定

---

## 💡 最佳实践

1. **先保证成功训练：**
   - 使用25个基础特征
   - 达到R² ≥ 0.70

2. **再考虑优化：**
   - 调整模型架构（层数、单元数）
   - 调整超参数（学习率、批次大小）
   - 增加训练epoch

3. **谨慎尝试特征工程：**
   - 仅在基础训练完全稳定后
   - 逐步添加少量特征（不是200+）
   - 每次添加后验证稳定性

---

## 🆘 如果仍然失败

如果按照上述步骤，仍然出现NaN：

1. **截图发送：**
   - "步骤1.9: 训练前最终检查"的结果
   - 特征配置区域的截图
   - NaN错误的完整信息

2. **检查数据文件：**
   - `矿压数据.csv` 是否完整
   - `支架坐标数据.csv` 是否存在
   - `地质特征数据.csv` 是否正确

3. **环境检查：**
   ```powershell
   python --version  # 应该是3.11
   python -c "import torch; print(torch.__version__)"  # PyTorch版本
   python -c "import numpy; print(numpy.__version__)"  # NumPy版本
   ```

---

**总结：确保"启用特征工程"未勾选，看到25个特征，然后开始训练！**
