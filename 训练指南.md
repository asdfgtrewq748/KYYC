# STGCN 矿压预测系统 - 训练指南

## 系统概述

基于时空图卷积网络(STGCN)的煤矿支架压力预测系统，整合了钻孔地质数据和支架工作循环数据。

## 数据说明

### 输入数据
- **预处理数据集**: `processed_data/sequence_dataset.npz`
  - 195,836 个训练样本
  - 125 个支架节点
  - 17 维特征向量 (6个压力特征 + 9个地质特征 + 2个时间特征)
  - 5个历史步长 → 预测1个未来步长

### 特征组成

#### 压力特征 (6个)
1. 初撑力值 (MPa)
2. 末阻力值 (MPa)
3. 压力增量 (MPa)
4. 压力增长率 (%)
5. 循环时长 (秒)
6. 压力变化速率 (MPa/秒)

#### 地质特征 (9个)
7. geo_total_thickness_m - 总厚度
8. geo_coal_thickness_m - 煤层厚度
9. geo_coal_seam_count - 煤层数量
10. geo_depth_to_top_coal_m - 顶煤深度
11. geo_avg_elastic_modulus_GPa - 平均弹性模量
12. geo_avg_density_kN_m3 - 平均密度
13. geo_max_tensile_MPa - 最大抗拉强度
14. geo_prop_sandstone - 砂岩比例
15. geo_prop_mudstone - 泥岩比例

#### 时间特征 (2个)
16. 小时 (0-23)
17. 星期几 (0-6)

## 快速开始

### 方法1: 使用启动脚本 (推荐)
```bash
双击运行: 启动训练界面.bat
```

### 方法2: 命令行启动
```bash
conda activate kan
streamlit run STGCN.py
```

## 训练流程

### 1. 选择数据源
在侧边栏选择 **"使用预处理数据集"**

### 2. 数据分割
调整训练集/验证集/测试集比例:
- 默认: 70% / 15% / 15%
- 可根据需求调整

### 3. 图结构配置
选择邻接矩阵生成方式:
- **distance**: 基于坐标距离 (需要坐标文件)
- **knn**: K近邻图 (K=5推荐)
- **chain**: 链式连接
- **full**: 全连接图

### 4. 训练参数设置

#### 基础参数
- **训练轮数 (epochs)**: 50-200 (默认50)
- **批次大小 (batch_size)**: 32-128 (默认64)
- **学习率 (learning_rate)**: 0.001 (默认)
- **隐藏层维度 (hidden_dim)**: 64 (默认)

#### 推荐配置

**快速测试**:
```
epochs: 50
batch_size: 64
learning_rate: 0.001
```

**正式训练**:
```
epochs: 150
batch_size: 32
learning_rate: 0.0005
```

**大规模训练**:
```
epochs: 300
batch_size: 128
learning_rate: 0.0001
```

### 5. 开始训练
点击 **"🚀 开始训练"** 按钮

系统会自动:
1. ✅ 数据格式转换 (序列 → 图结构)
2. ✅ 模型初始化 (STGCN网络)
3. ✅ GPU加速 (如果可用)
4. ✅ 实时显示训练进度
5. ✅ 自动保存最佳模型

## 训练监控

### 实时指标
- **训练损失** (MSE)
- **验证损失** (MSE)
- **MAE**: 平均绝对误差 (MPa)
- **RMSE**: 均方根误差 (MPa)
- **R²**: 决定系数 (拟合优度)

### 可视化
- 📈 训练/验证损失曲线
- 🎯 预测vs真实值对比
- 🔍 邻接矩阵热力图

## 输出文件

### 模型文件
- `best_stgcn_model.pth` - 最佳验证性能的模型权重

### 评估指标
训练完成后会显示:
- 最终MAE、RMSE、R²指标
- 5个随机样本的预测对比表
- 预测误差率分析

## 模型结构

```
STGCN 架构:
输入: (Batch, 17 features, 125 nodes, 5 time_steps)
  ↓
STGCNBlock1 (时序卷积 + 图卷积 + 时序卷积)
  ↓
STGCNBlock2 (时序卷积 + 图卷积 + 时序卷积)
  ↓
时间卷积层
  ↓
输出映射
  ↓
输出: (Batch, 1, 125 nodes, 1) - 末阻力预测
```

## 性能优化建议

### 硬件要求
- **最低**: CPU + 8GB RAM
- **推荐**: NVIDIA GPU (RTX 3060以上) + 16GB RAM
- **最佳**: RTX 4090/5090 + 32GB RAM

### 训练加速
1. 启用CUDA GPU加速 (自动检测)
2. 增大batch_size (如果显存充足)
3. 使用混合精度训练 (未来版本)

### 过拟合预防
- 提前停止 (Early Stopping) - 已内置
- 数据增强 (可在预处理阶段添加)
- Dropout (模型中可配置)

## 常见问题

### Q: 训练速度慢?
**A**: 
- 检查是否使用GPU (`使用设备: cuda:0`)
- 减小batch_size或epochs
- 使用更小的hidden_dim

### Q: 验证损失不下降?
**A**: 
- 降低学习率 (0.001 → 0.0005)
- 增加训练轮数
- 检查数据质量

### Q: 显存不足?
**A**: 
- 减小batch_size (64 → 32 → 16)
- 减小hidden_dim (64 → 32)
- 关闭其他GPU应用

### Q: 预测精度低?
**A**: 
- 增加训练轮数 (50 → 150)
- 调整图结构 (尝试knn或distance)
- 检查特征工程是否合理

## 下一步工作

- [ ] 实现实时预测界面
- [ ] 添加模型对比功能 (LSTM/Transformer)
- [ ] 支持在线增量学习
- [ ] 集成异常检测模块
- [ ] 开发移动端应用

## 技术支持

如有问题，请参考:
- 数据预处理: `preprocess/prepare_training_data.py`
- 地质特征提取: `preprocess/geology_features.py`
- 数据验证: `validate_dataset.py`
- 策略文档: `矿压数据使用策略.py`

---
**版本**: v1.0  
**更新时间**: 2025-01  
**开发者**: KYYC团队
